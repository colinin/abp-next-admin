# 集成测试

<cite>
**本文档中引用的文件**  
- [AbpTestsBase.cs](file://aspnet-core/tests/LINGYUN.Abp.TestBase/LINGYUN/Abp/Tests/AbpTestsBase.cs)
- [AbpTestsBaseModule.cs](file://aspnet-core/tests/LINGYUN.Abp.TestBase/LINGYUN/Abp/Tests/AbpTestsBaseModule.cs)
- [AbpEntityFrameworkCoreTestModule.cs](file://aspnet-core/tests/LINGYUN.Abp.EntityFrameworkCore.Tests/LINGYUN/Abp/EntityFrameworkCore/AbpEntityFrameworkCoreTestModule.cs)
- [EfCoreTestDbContext.cs](file://aspnet-core/tests/LINGYUN.Abp.EntityFrameworkCore.Tests/LINGYUN/Abp/EntityFrameworkCore/EfCoreTestDbContext.cs)
- [AbpAuditLoggingElasticsearchTestModule.cs](file://aspnet-core/tests/LINGYUN.Abp.AuditLogging.Elasticsearch.Tests/LINGYUN/Abp/AuditLogging/Elasticsearch/AbpAuditLoggingElasticsearchTestModule.cs)
- [AbpAuditLoggingElasticsearchTestBase.cs](file://aspnet-core/tests/LINGYUN.Abp.AuditLogging.Elasticsearch.Tests/LINGYUN/Abp/AuditLogging/Elasticsearch/AbpAuditLoggingElasticsearchTestBase.cs)
- [AuditLogManagerTests.cs](file://aspnet-core/tests/LINGYUN.Abp.AuditLogging.Elasticsearch.Tests/LINGYUN/Abp/AuditLogging/Elasticsearch/AuditLogManagerTests.cs)
- [appsettings.Testing.json](file://aspnet-core/tests/LINGYUN.Abp.Dapr.Actors.Tests/appsettings.Testing.json)
- [AbpDaprTestModule.cs](file://aspnet-core/tests/LINGYUN.Abp.Dapr.Tests/LINGYUN/Abp/Dapr/AbpDaprTestModule.cs)
</cite>

## 目录
1. [引言](#引言)
2. [集成测试的作用](#集成测试的作用)
3. [测试环境配置](#测试环境配置)
4. [测试基类与生命周期管理](#测试基类与生命周期管理)
5. [数据库集成测试](#数据库集成测试)
6. [外部服务集成测试](#外部服务集成测试)
7. [实际测试代码示例](#实际测试代码示例)
8. [结论](#结论)

## 引言
本项目采用ABP框架构建微服务架构，集成测试在确保系统各组件协同工作方面起着至关重要的作用。本文档详细阐述了集成测试的实现方式，包括测试环境配置、测试基类使用、数据库和外部服务的集成验证等关键内容。

## 集成测试的作用
集成测试在本项目中主要用于验证不同模块和服务之间的交互是否正确，确保系统整体功能的完整性。特别针对数据库、Dapr、Elasticsearch等外部依赖服务，集成测试能够验证数据持久化、服务间通信和分布式功能的正确性。

集成测试的主要作用包括：
- 验证服务间调用的正确性
- 确保数据在不同组件间正确传递和持久化
- 验证外部服务（如Dapr、Elasticsearch）的集成功能
- 检测系统层面的错误和异常处理
- 保证系统在真实环境下的稳定性和可靠性

**Section sources**
- [AbpTestsBase.cs](file://aspnet-core/tests/LINGYUN.Abp.TestBase/LINGYUN/Abp/Tests/AbpTestsBase.cs)
- [AbpTestsBaseModule.cs](file://aspnet-core/tests/LINGYUN.Abp.TestBase/LINGYUN/Abp/Tests/AbpTestsBaseModule.cs)

## 测试环境配置
测试环境的配置是集成测试的基础，本项目通过多种方式确保测试环境的独立性和可重复性。

### 配置文件管理
项目使用`appsettings.Testing.json`文件来管理测试专用的配置，例如Dapr服务的连接信息：

```json
{
  "RemoteServices": {
    "TestDapr": {
      "BaseUrl": "http://127.0.0.1:10000"
    }
  }
}
```

### 服务依赖配置
在测试模块中，通过`PreConfigureServices`方法配置测试所需的依赖服务：

```csharp
public override void PreConfigureServices(ServiceConfigurationContext context)
{
    var configurationOptions = new AbpConfigurationBuilderOptions
    {
        EnvironmentName = "Development",
        UserSecretsId = Environment.GetEnvironmentVariable("APPLICATION_USER_SECRETS_ID"),
        UserSecretsAssembly = typeof(AbpTestsBaseModule).Assembly
    };

    context.Services.ReplaceConfiguration(ConfigurationHelper.BuildConfiguration(configurationOptions));
}
```

### 数据库上下文配置
对于数据库集成测试，项目使用内存数据库来确保测试的独立性和快速执行：

```csharp
Configure<AbpDbContextOptions>(options =>
{
    options.Configure(abpDbContextConfigurationContext =>
    {
        abpDbContextConfigurationContext.DbContextOptions.EnableDetailedErrors();
        abpDbContextConfigurationContext.DbContextOptions.EnableSensitiveDataLogging();
        abpDbContextConfigurationContext.DbContextOptions.UseInMemoryDatabase(memoryDbName);
    });
});
```

**Section sources**
- [AbpTestsBaseModule.cs](file://aspnet-core/tests/LINGYUN.Abp.TestBase/LINGYUN/Abp/Tests/AbpTestsBaseModule.cs)
- [AbpEntityFrameworkCoreTestModule.cs](file://aspnet-core/tests/LINGYUN.Abp.EntityFrameworkCore.Tests/LINGYUN/Abp/EntityFrameworkCore/AbpEntityFrameworkCoreTestModule.cs)
- [appsettings.Testing.json](file://aspnet-core/tests/LINGYUN.Abp.Dapr.Actors.Tests/appsettings.Testing.json)

## 测试基类与生命周期管理
项目通过抽象的测试基类来统一管理集成测试的生命周期和公共功能。

### 测试基类设计
`AbpTestsBase<TStartupModule>`作为所有集成测试的基类，继承自`AbpIntegratedTest<TStartupModule>`，提供了统一的测试环境初始化和清理机制：

```csharp
public abstract class AbpTestsBase<TStartupModule> : AbpIntegratedTest<TStartupModule>
    where TStartupModule : IAbpModule
{
    protected override void SetAbpApplicationCreationOptions(AbpApplicationCreationOptions options)
    {
        options.UseAutofac();
    }
}
```

### 工作单元管理
测试基类提供了`WithUnitOfWorkAsync`方法来管理数据库事务，确保每个测试的独立性：

```csharp
protected virtual async Task WithUnitOfWorkAsync(AbpUnitOfWorkOptions options, Func<Task> action)
{
    using (var scope = ServiceProvider.CreateScope())
    {
        var uowManager = scope.ServiceProvider.GetRequiredService<IUnitOfWorkManager>();

        using (var uow = uowManager.Begin(options))
        {
            await action();

            await uow.CompleteAsync();
        }
    }
}
```

### 测试生命周期
测试的生命周期通过ABP框架的模块系统管理，确保每个测试在独立的依赖注入容器中运行，避免测试间的相互影响。

**Section sources**
- [AbpTestsBase.cs](file://aspnet-core/tests/LINGYUN.Abp.TestBase/LINGYUN/Abp/Tests/AbpTestsBase.cs)
- [AbpTestsBaseModule.cs](file://aspnet-core/tests/LINGYUN.Abp.TestBase/LINGYUN/Abp/Tests/AbpTestsBaseModule.cs)

## 数据库集成测试
数据库集成测试是验证数据持久化功能的关键，本项目通过内存数据库实现快速、独立的测试。

### 内存数据库配置
项目使用Entity Framework Core的内存数据库提供程序，为每个测试创建独立的数据库实例：

```csharp
context.Services.AddEntityFrameworkInMemoryDatabase();

var memoryDbName = Guid.NewGuid().ToString();

Configure<AbpDbContextOptions>(options =>
{
    options.Configure(abpDbContextConfigurationContext =>
    {
        abpDbContextConfigurationContext.DbContextOptions.UseInMemoryDatabase(memoryDbName);
    });
});
```

### 测试数据准备
通过数据播种器（Data Seeder）在测试前准备必要的测试数据：

```csharp
AsyncHelper.RunSync(async () =>
    await new EfCoreTestEntityDataSeeder(dbConetxt).SeedAsync());
```

### 测试独立性保证
通过为每个测试生成唯一的数据库名称，确保测试间的完全隔离：

```csharp
var databaseName = Guid.NewGuid().ToString();
```

**Section sources**
- [AbpEntityFrameworkCoreTestModule.cs](file://aspnet-core/tests/LINGYUN.Abp.EntityFrameworkCore.Tests/LINGYUN/Abp/EntityFrameworkCore/AbpEntityFrameworkCoreTestModule.cs)
- [EfCoreTestDbContext.cs](file://aspnet-core/tests/LINGYUN.Abp.EntityFrameworkCore.Tests/LINGYUN/Abp/EntityFrameworkCore/EfCoreTestDbContext.cs)

## 外部服务集成测试
项目集成了多种外部服务，包括Dapr、Elasticsearch等，集成测试确保这些服务的正确连接和功能。

### Dapr集成测试
Dapr作为分布式应用运行时，其集成测试通过配置远程服务基地址来实现：

```json
{
  "RemoteServices": {
    "TestDapr": {
      "BaseUrl": "http://127.0.0.1:10000"
    }
  }
}
```

测试模块依赖`AbpDddApplicationContractsModule`，确保Dapr相关功能的正确初始化：

```csharp
[DependsOn(
    typeof(AbpDddApplicationContractsModule))]
public class AbpDaprTestModule : AbpModule
{
}
```

### Elasticsearch集成测试
Elasticsearch用于审计日志存储，其集成测试模块配置了专门的测试选项：

```csharp
[DependsOn(
    typeof(AbpTestsBaseModule),
    typeof(AbpAuditLoggingElasticsearchModule))]
public class AbpAuditLoggingElasticsearchTestModule : AbpModule
{
    public override void OnApplicationShutdown(ApplicationShutdownContext context)
    {
        var options = context.ServiceProvider.GetRequiredService<IOptions<AbpAuditLoggingElasticsearchOptions>>().Value;
        var clientFactory = context.ServiceProvider.GetRequiredService<IElasticsearchClientFactory>();
        var client = clientFactory.Create();
        var indicesResponse = client.Cat.Indices(i => i.Index($"{options.IndexPrefix}-security-log"));
        foreach (var index in indicesResponse.Records)
        {
            client.Indices.Delete(index.Index);
        }
    }
}
```

测试基类继承自通用测试基类，确保测试环境的一致性：

```csharp
public abstract class AbpAuditLoggingElasticsearchTestBase : AbpTestsBase<AbpAuditLoggingElasticsearchTestModule>
{
}
```

**Section sources**
- [AbpDaprTestModule.cs](file://aspnet-core/tests/LINGYUN.Abp.Dapr.Tests/LINGYUN/Abp/Dapr/AbpDaprTestModule.cs)
- [appsettings.Testing.json](file://aspnet-core/tests/LINGYUN.Abp.Dapr.Actors.Tests/appsettings.Testing.json)
- [AbpAuditLoggingElasticsearchTestModule.cs](file://aspnet-core/tests/LINGYUN.Abp.AuditLogging.Elasticsearch.Tests/LINGYUN/Abp/AuditLogging/Elasticsearch/AbpAuditLoggingElasticsearchTestModule.cs)
- [AbpAuditLoggingElasticsearchTestBase.cs](file://aspnet-core/tests/LINGYUN.Abp.AuditLogging.Elasticsearch.Tests/LINGYUN/Abp/AuditLogging/Elasticsearch/AbpAuditLoggingElasticsearchTestBase.cs)

## 实际测试代码示例
以下是一个实际的集成测试代码示例，展示了如何验证审计日志功能：

```csharp
public class AuditLogManagerTests : AbpAuditLoggingElasticsearchTestBase
{
    private readonly IAuditLogManager _manager;

    public AuditLogManagerTests()
    {
        _manager = GetRequiredService<IAuditLogManager>();
    }

    [Fact]
    public async Task Save_Audit_Log_Should_Get_List()
    {
        (await _manager.GetCountAsync(hasException: true)).ShouldBe(3);
        (await _manager.GetCountAsync(hasException: false)).ShouldBe(7);
        (await _manager.GetCountAsync(httpMethod: "POST")).ShouldBe(5);
        
        var logs = await _manager.GetListAsync(userName: "_user_5", clientId: "_client_5");
        logs.Count.ShouldBe(1);
        logs[0].Url.ShouldBe("_url_5");
    }

    protected async virtual Task<List<string>> MockcAsync(int count)
    {
        var mock = new AutoMocker();
        var auditLogIds = new List<string>();

        for (int i = 1; i <= count; i++)
        {
            var auditLogInfo = mock.CreateInstance<AuditLogInfo>();
            auditLogInfo.ClientId = $"_client_{i}";
            auditLogInfo.Url = $"_url_{i}";
            auditLogInfo.UserName = $"_user_{i}";
            
            if (i % 3 == 0)
            {
                auditLogInfo.Exceptions.Add(new Exception($"_exception_{i}"));
            }

            auditLogIds.Add(await _manager.SaveAsync(auditLogInfo));
        }

        return auditLogIds;
    }
}
```

该测试示例展示了：
- 如何获取服务实例进行测试
- 如何验证数据查询功能
- 如何准备测试数据
- 如何验证数据持久化结果

**Section sources**
- [AuditLogManagerTests.cs](file://aspnet-core/tests/LINGYUN.Abp.AuditLogging.Elasticsearch.Tests/LINGYUN/Abp/AuditLogging/Elasticsearch/AuditLogManagerTests.cs)

## 结论
本项目的集成测试体系通过统一的测试基类、独立的测试环境和全面的外部服务集成验证，确保了系统的稳定性和可靠性。通过内存数据库和配置隔离，实现了测试的快速执行和完全独立性。对于Dapr、Elasticsearch等外部服务，通过专门的测试配置和清理机制，保证了集成测试的完整性和准确性。

集成测试不仅是验证功能正确性的手段，更是保障系统质量的重要环节。建议在开发新功能时，同步编写相应的集成测试，确保代码变更不会影响现有功能。